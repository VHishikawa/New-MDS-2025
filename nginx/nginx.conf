# nginx/nginx.conf

worker_processes auto;

events {
    worker_connections 2048; 
}

http {
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_read_timeout 300s; 
    proxy_send_timeout 300s;
    client_max_body_size 1G; # Permite uploads maiores (ex: para MinIO, NiFi)

    server {
        listen 80;
        server_name localhost seu-dominio.ddns.net; # Adicione seu domï¿½nio No-IP aqui

        location /airflow/ {
            rewrite ^/airflow/(.*)$ /$1 break;
            proxy_pass http://airflow_webserver:8080;
        }
        location /spark/ {
            rewrite ^/spark/(.*)$ /$1 break;
            proxy_pass http://spark-master:8080;
        }
        location /flink/ {
            rewrite ^/flink/(.*)$ /$1 break;
            proxy_pass http://flink-jobmanager:8081;
        }

        # --- ARMAZENAMENTO E BANCOS DE DADOS ---
        location /minio/ {
            rewrite ^/minio/(.*)$ /$1 break;
            proxy_pass http://minio_storage:9001;
        }
        location /neo4j/ {
            rewrite ^/neo4j/(.*)$ /$1 break;
            proxy_pass http://neo4j_db:7474;
        }
        

        location /nifi/ {
            rewrite ^/nifi/(.*)$ /$1 break;
            proxy_pass http://nifi:8080;
        }
        location /openmetadata/ {
            rewrite ^/openmetadata/(.*)$ /$1 break;
            proxy_pass http://openmetadata-server:8585;
        }

        location /superset/ {
            rewrite ^/superset/(.*)$ /$1 break;
            proxy_pass http://superset_app:8088;
        }
        location /kibana/ {
            rewrite ^/kibana/(.*)$ /$1 break;
            proxy_pass http://kibana:5601;
        }
        location /trino/ {
            rewrite ^/trino/(.*)$ /$1 break;
            proxy_pass http://trino-coordinator:8080;
        }
        location /dbeaver/ {
            rewrite ^/dbeaver/(.*)$ /$1 break;
            proxy_pass http://dbeaver_ui:8978;
        }
        location /jupyter/ {
            rewrite ^/jupyter/(.*)$ /$1 break;
            proxy_pass http://notebook-spark:8888;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_http_version 1.1;
        }
        
        location /clickhouse/ {
            proxy_pass http://clickhouse:8123;
        }
        location /pinot/ {
            rewrite ^/pinot/(.*)$ /$1 break;
            proxy_pass http://pinot-controller:9000;
        }

        # --- CI/CD E MONITORAMENTO ---
        location /jenkins/ {
            proxy_pass http://jenkins_ci_cd:8080;
            proxy_set_header X-Forwarded-Context-Path /jenkins;
        }
        location /prometheus/ {
            rewrite ^/prometheus/(.*)$ /$1 break;
            proxy_pass http://prometheus:9090;
        }
        location /grafana/ {
            rewrite ^/grafana/(.*)$ /$1 break;
            proxy_pass http://grafana:3000;
        }

        location /n8n/ {
            rewrite ^/n8n/(.*)$ /$1 break;
            proxy_pass http://n8n:5678;
        }
    }
}