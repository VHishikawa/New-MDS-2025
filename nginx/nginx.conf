# nginx/nginx.conf - VERSÃO FINAL E AJUSTADA

worker_processes auto;

events {
    worker_connections 2048;
}

http {
    # --- CONFIGURAÇÕES GLOBAIS DE PROXY ---
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 90s;
    proxy_read_timeout 90s;
    client_max_body_size 1G;
    
    # Adiciona o resolvedor DNS do Docker para que o Nginx encontre os outros contêineres.
    resolver 127.0.0.11 valid=30s;

    server {
        listen 80;
        server_name mds-server.local; 

        # --- ORQUESTRAÇÃO E PROCESSAMENTO ---
        location /airflow/ {
            proxy_pass http://airflow_webserver:8080;
            # A diretiva proxy_redirect não é mais necessária aqui, pois a BASE_URL do Airflow já cuida disso.
        }

        location /spark/ {
            proxy_pass http://spark-master:8080/;
            proxy_redirect / /spark/;
        }

        location /flink/ {
            proxy_pass http://flink-jobmanager:8081/;
            proxy_redirect / /flink/;
        }

        # --- ARMAZENAMENTO E BANCOS DE DADOS ---
        location /minio/ {
            proxy_pass http://minio_storage:9001/;
            proxy_redirect / /minio/;
        }

        location /neo4j/ {
            proxy_pass http://neo4j_db:7474/;
            proxy_redirect / /neo4j/;
        }

        # --- STREAMING (CONFLUENT PLATFORM) ---
        location /control-center/ {
            proxy_pass http://kafka_control_center:9021/;
            proxy_redirect / /control-center/;
        }

        # --- INGESTÃO E GOVERNANÇA ---
        location /nifi/ {
            proxy_pass http://nifi:8080/nifi/;
            proxy_redirect / /nifi/;
        }

        location /openmetadata/ {
            proxy_pass http://openmetadata-server:8585/;
            proxy_redirect / /openmetadata/;
        }

        # --- VISUALIZAÇÃO E FERRAMENTAS ---
        location /superset/ {
            proxy_pass http://superset_app:8088/;
            proxy_redirect / /superset/;
        }

        location /kibana/ {
            proxy_pass http://kibana:5601/;
            proxy_redirect / /kibana/;
        }

        location /trino/ {
            proxy_pass http://trino-coordinator:8080/;
            proxy_redirect / /trino/;
        }

        location /dbeaver/ {
            proxy_pass http://dbeaver_ui:8978/;
            proxy_redirect / /dbeaver/;
        }

        location /jupyter/ {
            proxy_pass http://notebook-spark:8888/;
            proxy_redirect / /jupyter/;
        }
        
        location /hiveserver/ {
            proxy_pass http://hive-server:10002/;
            proxy_redirect / /hiveserver/;
        }

        # --- ANÁLISE EM TEMPO REAL ---
        location /clickhouse/ {
            proxy_pass http://clickhouse_server:8123/;
            proxy_redirect / /clickhouse/;
        }
        
        location /pinot/ {
            proxy_pass http://pinot-controller:9000/;
            proxy_redirect / /pinot/;
        }

        # --- CI/CD E MONITORAMENTO ---
        location /jenkins/ {
            proxy_pass http://jenkins_ci_cd:8080/;
            proxy_set_header X-Forwarded-Context-Path /jenkins; # Jenkins precisa deste header específico
            proxy_redirect / /jenkins/;
        }

        location /prometheus/ {
            proxy_pass http://prometheus:9090/;
            proxy_redirect / /prometheus/;
        }

        location /grafana/ {
            proxy_pass http://grafana:3000/;
            proxy_redirect / /grafana/;
        }

        # --- AUTOMAÇÃO E INTEGRAÇÃO ---
        location /n8n/ {
            proxy_pass http://n8n:5678/;
            proxy_redirect / /n8n/;
        }
    }
}